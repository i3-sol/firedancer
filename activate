#!/bin/sh

# Note that this script is used by internally at Jump to configure the
# development environment on a host.  For non-Jump hosts, this
# implicitly documents the external required dependencies.
#
# In short, very little.
# Requires a standard modern Linux install (usually use RHEL8.3
# internally but are not too dependent on choice of distribution),
# usually compiled with gcc-9.3.0 (but are not be too dependent on
# choice or version of compiler) and need the numactl-devel package
# installed.
# Also installs the Bazel compiler.

if [ $# -gt 0 ] && [ "$1" = "install" ]; then
  # Install Packages needed for dev hosts
  sudo yum install                \
    numactl-devel                 \
    jump_module_gcc-9.3.0         \
    jump_module_java-cacerts-jump

  # Install Bazel config.
  # The home .bazelrc file is special because it gets
  # automatically loaded on startup.
  # To avoid deleting any custom user config,
  # it is only created if it doesn't exist yet.
  # https://bazel.build/run/bazelrc#bazelrc-file-locations
  if [ ! -f ~/.bazelrc ]; then
    echo "Installing ~/.bazelrc"
    cat <<EOF > ~/.bazelrc
import $HOME/.bazelrc-auto
EOF
  else
    echo "Skipping ~/.bazelrc installation (already exists)"
  fi
  # Since ~/.bazelrc is immutable for aforementioned reasons,
  # Firedancer-managed config is separated out to a second config file.
  # This file is overwritten on each install.
  echo "Installing ~/.bazelrc/auto"
  cat <<EOF > ~/.bazelrc-auto
# Generated by firedancer/activate. Do not edit!
startup --host_jvm_args="-Djavax.net.ssl.trustStore=/jump/software/rhel8/java-cacerts-jump/cacerts"
build --java_runtime_version=remotejdk_11
EOF
fi

module purge
module load gcc-9.3.0
module load java-cacerts-jump
module list

