#!/bin/sh

if [ $# -ne 4 ]; then
  echo ""
  echo "        Usage: $0 [APP_NAME] [APP_CORE_TARGET] [VERIFY_CNT] [BUILD]"
  echo ""
  exit 1
fi

APP=$1
AFFINITY=$2
VERIFY_CNT=$3
BUILD=$4
shift 4

#######################################################################

CONF=tmp/$APP.cfg

WKSP=$APP.wksp
WKSP_PAGE_CNT=1
WKSP_PAGE_SZ=gigantic
WKSP_PERM=0600

POD_SZ=8192

CNC_APP_SZ=4032

VERIFY_DEPTH=8192
VERIFY_MTU=1542    # FIXME: HMMMM

DEDUP_TCACHE_DEPTH=4194302
DEDUP_TCACHE_MAP_CNT=0
DEDUP_DEPTH=$VERIFY_DEPTH

#######################################################################

FD_LOG_PATH=""
export FD_LOG_PATH

$BUILD/bin/fd_wksp_ctl delete $WKSP # Okay if fails ... might not exist already
$BUILD/bin/fd_wksp_ctl new $WKSP $WKSP_PAGE_CNT $WKSP_PAGE_SZ $AFFINITY $WKSP_PERM || exit $?

POD=`$BUILD/bin/fd_pod_ctl new $WKSP $POD_SZ` || exit $?

MAIN_CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 0 tic $CNC_APP_SZ` || exit $?
$BUILD/bin/fd_pod_ctl                      \
  insert $POD cstr $APP.main.cnc $MAIN_CNC \
  || exit $?

CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 0 tic $CNC_APP_SZ` || exit $?
$BUILD/bin/fd_pod_ctl                 \
  insert $POD cstr $APP.pack.cnc $CNC \
  || exit $?

CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 1 tic $CNC_APP_SZ` || exit $?
TCACHE=`$BUILD/bin/fd_tango_ctl new-tcache $WKSP $DEDUP_TCACHE_DEPTH $DEDUP_TCACHE_MAP_CNT` || exit $?
MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $DEDUP_DEPTH 0 0` || exit $?
FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
# Use defaults for cr_max, lazy, seed
$BUILD/bin/fd_pod_ctl                        \
  insert $POD cstr $APP.dedup.cnc    $CNC    \
  insert $POD cstr $APP.dedup.tcache $TCACHE \
  insert $POD cstr $APP.dedup.mcache $MCACHE \
  insert $POD cstr $APP.dedup.fseq   $FSEQ   \
  || exit $?

for((verify_idx=0;verify_idx<VERIFY_CNT;verify_idx++)); do
  CNC=`$BUILD/bin/fd_tango_ctl new-cnc $WKSP 2 tic $CNC_APP_SZ` || exit $?
  MCACHE=`$BUILD/bin/fd_tango_ctl new-mcache $WKSP $VERIFY_DEPTH 0 0` || exit $?
  DCACHE=`$BUILD/bin/fd_tango_ctl new-dcache $WKSP $VERIFY_MTU $VERIFY_DEPTH 1 1 0` || exit $?
  FSEQ=`$BUILD/bin/fd_tango_ctl new-fseq $WKSP 0` || exit $?
  $BUILD/bin/fd_pod_ctl                                      \
    insert $POD cstr $APP.verify.v$verify_idx.cnc    $CNC    \
    insert $POD cstr $APP.verify.v$verify_idx.mcache $MCACHE \
    insert $POD cstr $APP.verify.v$verify_idx.dcache $DCACHE \
    insert $POD cstr $APP.verify.v$verify_idx.fseq   $FSEQ   \
    || exit $?
done

CMDLINE_ARGS="--pod $POD --cfg $APP --log-app $APP --log-thread main"

#######################################################################

mkdir -pv `dirname $CONF` || exit $?
echo "#!/bin/sh"                       >  $CONF
echo "# AUTOGENERATED"                 >> $CONF
echo "BUILD=$BUILD"                    >> $CONF
echo "APP=$APP"                        >> $CONF
echo "AFFINITY=$AFFINITY"              >> $CONF
echo "WKSP=$WKSP"                      >> $CONF
echo "MAIN_CNC=$MAIN_CNC"              >> $CONF
echo "CMDLINE_ARGS=\"$CMDLINE_ARGS\""  >> $CONF

#######################################################################

echo Autogenerated configuration at $CONF
echo ""
cat $CONF
echo ""

echo Configuration details
echo ""
$BUILD/bin/fd_pod_ctl list $POD 2> /dev/null || exit $?
echo ""

echo success
exit 0

