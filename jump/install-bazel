#!/bin/bash
# Install dependencies on a Jump development machine. Ignore if not a Jump employee.
set -eu

install_deps () {
  # Install Packages needed for dev hosts
  sudo yum install                \
    jump_module_gcc-9.3.0         \
    numactl-devel                 \
    jump_module_java-cacerts-jump \
    jump_module_bazelisk-1.14.0   \
    jump_module_buildifier-4.2.0
}

install_bazelrc () {
  # Install Bazel config.
  # The home .bazelrc file is special because it gets
  # automatically loaded on startup.
  # To avoid deleting any custom user config,
  # it is only created if it doesn't exist yet.
  # https://bazel.build/run/bazelrc#bazelrc-file-locations
  if [ ! -f ~/.bazelrc ]; then
    echo "Installing ~/.bazelrc"
    cat <<EOF > ~/.bazelrc
import $HOME/.bazelrc-auto
EOF
  else
    echo "Skipping ~/.bazelrc installation (already exists)"
  fi
  # Since ~/.bazelrc is immutable for aforementioned reasons,
  # Firedancer-managed config is separated out to a second config file.
  # This file is overwritten on each install.
  echo "Installing ~/.bazelrc-auto"
  cat <<EOF > ~/.bazelrc-auto
# Generated by firedancer/activate. Do not edit!

# Java CA certs are supposed to be pre-installed in /etc/pki/java/cacerts.
# Unfortunately, this is not reliable, so we pull them from 'jump_module_java-cacerts-jump' instead.

startup --host_jvm_args="-Djavax.net.ssl.trustStore=/jump/software/rhel8/java-cacerts-jump/cacerts"
build --java_runtime_version=remotejdk_11
EOF
}

install_deps
install_bazelrc
