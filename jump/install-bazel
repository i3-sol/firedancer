#!/bin/sh
# Install dependencies on a Jump development machine. Ignore if not a Jump employee.
set -eu

install_bazelisk () {
  # https://github.com/bazelbuild/bazelisk/releases
  bazelisk_version="v1.14.0"
  bazelisk_sha256sum="84e946ed8537eaaa4d540df338a593e373e70c5ddca9f2f49e1aaf3a04bdd6ca"

  # Download from GitHub.
  echo "Installing baselisk $bazelisk_version"
  curl -sSfL -o "/tmp/.bazelisk.untrusted" \
    "https://github.com/bazelbuild/bazelisk/releases/download/$bazelisk_version/bazelisk-linux-amd64"
  # Enforce checksum.
  echo "$bazelisk_sha256sum  /tmp/.bazelisk.untrusted" | sha256sum --check
  # Install to home bin dir.
  mkdir -p ~/bin
  mv "/tmp/.bazelisk.untrusted" ~/bin/bazel
  chmod +x ~/bin/bazel

  echo "Installed bazelisk!"
  echo "Make sure you have $HOME/bin in your path."
}

install_deps () {
  # Install Packages needed for dev hosts
  sudo yum install                \
    jump_module_gcc-9.3.0         \
    numactl-devel                 \
    jump_module_clang-14.0        \
    jump_module_java-cacerts-jump \
    jump_module_buildifier-4.2.0  \
    jump_module_python39_importlib-metadata-4.12.0
}

install_bazelrc () {
  # Install Bazel config.
  # The home .bazelrc file is special because it gets
  # automatically loaded on startup.
  # To avoid deleting any custom user config,
  # it is only created if it doesn't exist yet.
  # https://bazel.build/run/bazelrc#bazelrc-file-locations
  if [ ! -f ~/.bazelrc ]; then
    echo "Installing ~/.bazelrc"
    cat <<EOF > ~/.bazelrc
import $HOME/.bazelrc-auto
EOF
  else
    echo "Skipping ~/.bazelrc installation (already exists)"
  fi
  # Since ~/.bazelrc is immutable for aforementioned reasons,
  # Firedancer-managed config is separated out to a second config file.
  # This file is overwritten on each install.
  echo "Installing ~/.bazelrc/auto"
  cat <<EOF > ~/.bazelrc-auto
# Generated by firedancer/activate. Do not edit!
startup --host_jvm_args="-Djavax.net.ssl.trustStore=/jump/software/rhel8/java-cacerts-jump/cacerts"
build --java_runtime_version=remotejdk_11
EOF
}

install_deps
install_bazelisk
install_bazelrc
